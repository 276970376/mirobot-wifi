<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>WiFi connection</title>
<style>body{background-color:#FFF;font-family:sans-serif}label{display:block;margin:10px 0}.info{margin:15px 0;font-size:85%%;color:#999}.info p{margin:6px 0}h1{font-size:1.25em}#message{margin:10px 0}#fileInput{border:3px dashed #AAA;width:100%;height:500px}</style>
<script type="text/javascript">function readFile(e){var t=new FileReader(e);t.onload=function(e){fileContents=e.target.result,binFileContents=hex2bin(fileContents),console.log(fileContents.substr(1,fileContents.indexOf("\n"))),document.getElementById("fileInput").style.display="none",document.getElementById("upload").style.display="block"},t.readAsText(e)}function handleFileSelect(e){if(e.stopPropagation(),e.preventDefault(),"undefined"!=typeof e.dataTransfer)var t=e.dataTransfer.files;else if("undefined"!=typeof e.target)var t=e.target.files;return 1!=t.length?void alert("please select a single hex file to upload"):(readFile(t[0]),!1)}function handleDragOver(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}var fileContents,binFileContents,hex2bin=function(e){var t=[];e.toString().split("\n").map(function(e){var n=parseInt(e.slice(1,3),16);if(n&&"00"===e.slice(7,9)){data=e.slice(9,9+2*n);for(var o=0;2*n>o;o+=2)t.push(parseInt(data.slice(o,o+2),16))}});for(var n=0;n<t.length%4;n++)t.push(0);return new Uint8Array(t)},doUpload=function(){var e=new XMLHttpRequest;e.open("POST","/updatearduino.cgi"),e.onload=function(){this.status>=200&&this.status<300?(document.getElementById("upload").style.display="none",document.getElementById("flash").style.display="block"):console.log("Error")},e.send(binFileContents)},updateStatus=function(){var e=new XMLHttpRequest;e.open("GET","/flasharduino.cgi"),e.onload=function(){if(this.status>=200&&this.status<300){var t=JSON.parse(e.response);"flashing"===t.state?(document.getElementById("msg").innerHTML="Arduino flashing ("+Math.floor(t.pages/240*100)+"%)",window.setTimeout(updateStatus,1e3)):document.getElementById("msg").innerHTML="Arduino flashing complete"}else console.log("Error")},e.send()},doFlash=function(){var e=new XMLHttpRequest;e.open("POST","/flasharduino.cgi"),e.onload=function(){this.status>=200&&this.status<300?(document.getElementById("flash").style.display="none",document.getElementById("msg").innerHTML="Arduino flashing (0%)",document.getElementById("msg").style.display="block"):console.log("Error")},e.send(),window.setTimeout(updateStatus,1e3)},pullFile=function(e){console.log("Fetching: "+e);var t=new XMLHttpRequest;t.onreadystatechange=function(){4===t.readyState&&200===t.status},t.open("GET","http://corsify.appspot.com/"+e,!0),t.send()},pullVersions=function(){var e=new XMLHttpRequest;e.onreadystatechange=function(){if(4===e.readyState&&200===e.status)for(var t=JSON.parse(e.response),n=0;n<t.length;n++)if(!t[n].prerelease&&(console.log(t[n]),t[n].assets.length>0))for(var o=0;o<t[n].assets.length;o++)if("mirobot.hex"===t[n].assets[o].name)return void pullFile(t[n].assets[o].browser_download_url)},e.open("GET","https://api.github.com/repos/bjpirt/mirobot-arduino/releases",!0),e.send()},init=function(){document.getElementById("fileInput").onclick=function(){document.getElementById("files").click()},document.getElementById("files").addEventListener("change",handleFileSelect,!1);var e=document.getElementById("fileInput");e.addEventListener("dragover",handleDragOver,!1),e.addEventListener("drop",handleFileSelect,!1),document.querySelector("#upload button").onclick=doUpload,document.querySelector("#flash button").onclick=doFlash};window.onload=function(){init()};</script>
</head>
<body>
<h1>Upgrade Arduino</h1>
<div id="fileInput">
<p>Drag and drop the hex file here or click to choose the file manually</p>
<input type="file" id="files" style="display:none">
</div>
<div id="upload" style="display:none"><button>Upload new firmware</button></div>
<div id="flash" style="display:none"><button>Flash new firmware</button></div>
<p id="msg" style="display:none"></p>
</body>
</html>
