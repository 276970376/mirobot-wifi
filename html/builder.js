var FnInstance=function(t,n,e){this.fn=t,this.el=n,this.mirobot=e,this.parent=!1,this.children=[]};FnInstance.prototype={run:function(){var t=this;if(t.fn)t.fn.run(t,t.mirobot,function(n){t.updateState(n)});else for(var n in t.children)t.children[n].run()},updateState:function(t){"started"===t?$(this.el).addClass("active"):"complete"===t&&$(this.el).removeClass("active"),this.parent&&this.parent.el&&this.parent.updateState(t)},addChild:function(t){t.parent=this,this.children.push(t)},args:function(){var t=this,n={};return this.fn&&snack.each(this.fn.content,function(e){"object"==typeof e&&(n[e.name]=t.el.querySelector("[name="+e.name+"]").value)}),n},toObject:function(){var t={fn:this.fn?this.fn.name:"root",parent:this.fn?"parent"===this.fn.type:!0,args:this.args(),children:[]};return this.children.length&&(t.children=this.children.map(function(t){return t.toObject()})),t}};var Builder=function(t,n){var e=this;this.el=t,this.mirobot=n,this.init(),this.fns={},this.paused=!1,this.following=!1,this.colliding=!1,snack.each(this.functions,function(t){e.fns[t.name]=t})};Builder.prototype={prog:null,init:function(){var t=this;this.el.addClass("editor"),this.el[0].innerHTML=this.mainUI,this.setSize(),window.addEventListener("resize",function(){t.setSize()}),document.addEventListener("touchmove",function(t){for(var n=t.target;n=n.parentElement;)if("program"===n.id)return;t.preventDefault()},!1),this.runner=$(".editor .run"),this.pause=$(".editor .pause"),this.stop=$(".editor .stop"),this.clear=$(".editor .clear"),this.follow=$(".editor #follow"),this.collide=$(".editor #collide"),this.runner.attach("click",function(){t.runProgram()}),this.pause.attach("click",function(){t.pauseProgram()}),this.stop.attach("click",function(){t.stopProgram()}),this.clear.attach("click",function(){t.clearProgram()}),this.follow.attach("click",function(){t.followClick()}),this.collide.attach("click",function(){t.collideClick()}),this.mirobot.addListener(function(n){t.mirobotHandler(n)}),this.addFunctions(),this.resumeProgram()},supportsLocalStorage:function(){try{return"localStorage"in window&&null!==window.localStorage}catch(t){return!1}},storeProgram:function(){if(this.supportsLocalStorage()){var t=new FnInstance(null,null,null);this.generate($(".editor ol.program")[0],t),localStorage["mirobot.currentProgram"]=JSON.stringify(t.toObject())}},resumeProgram:function(){if(this.supportsLocalStorage()&&localStorage["mirobot.currentProgram"]){var t=JSON.parse(localStorage["mirobot.currentProgram"]);"root"===t.fn&&t.children&&t.children.length>0&&(this.instantiateProgram(t.children,document.querySelectorAll(".editor .program")[0]),this.showHints(),this.sortLists())}},instantiateProgram:function(t,n){var e=this;if(t&&t.length)for(var o=0;o<t.length;o++){var i=document.querySelectorAll(".functionList .fn-"+t[o].fn)[0].cloneNode(!0);n.appendChild(i);for(var r in t[o].args)if(t[o].args.hasOwnProperty(r)){var a=i.querySelector("[name='"+r+"']");a.value=t[o].args[r]}e.checkForChanges(i),snack.wrap(i).draggableList({target:"ol.program",placeholder:'<li class="placeholder"/>',copy:!1,ondrag:function(){e.showHints()},onchange:function(){e.storeProgram(),e.sortLists()}}),t[o].parent&&this.instantiateProgram(t[o].children,i.getElementsByTagName("ol")[0])}},setSize:function(){var t=window,n=document,e=n.documentElement,o=n.getElementsByTagName("body")[0],i=(t.innerWidth||e.clientWidth||o.clientWidth,t.innerHeight||e.clientHeight||o.clientHeight),r=this.el[0].getElementsByClassName("right")[0],a=this.el[0].getElementsByClassName("programWrapper")[0],s=this.el[0].getElementsByClassName("buttons")[0];r.style.height=i-r.offsetTop-27+"px",a.style.height=s.offsetTop-a.offsetTop+"px"},mirobotHandler:function(t){"program_complete"===t&&(this.runner.show(),this.pause.hide())},showHints:function(){$(".editor .programWrapper ol").each(function(t){t.getElementsByClassName("hint")[0].style.display=1===t.children.length?"block":"none"})},sortLists:function(){var t=this.el[0].querySelectorAll(".programWrapper li.end");snack.each(t,function(t){t.parentNode.appendChild(t)})},checkForChanges:function(t){var n=this,e=t.querySelectorAll("input, select");snack.each(e,function(t){t.addEventListener("change",function(){n.storeProgram()})})},addFunctions:function(){var t=this;snack.each(this.functions,function(n,e){e=t.functions[e];var o='<li class="function fn-'+e.name+' draggable" data-fntype="'+e.name+'">';for(var n in e.content)if("string"==typeof e.content[n])o+="<span> "+e.content[n]+" </span>";else if("object"==typeof e.content[n])if("number"===e.content[n].input)o+='<input type="number" size="4" name="'+e.content[n].name+'" value="'+e.content[n]["default"]+'" />';else if("option"===e.content[n].input){var i='<select name="'+e.content[n].name+'">';for(var r in e.content[n].values)i+='<option value="'+e.content[n].values[r]+'"',e.content[n]["default"]===e.content[n].values[r]&&(i+='selected="selected"'),i+=">"+e.content[n].values[r]+"</option>";i+="</select>",o+=i}"parent"===e.type&&(o+='<ol><li class="end"><div class="hint">Drag functions into here!</div></li></li></ol>'),o+="</li>",$(".editor .functionList")[0].innerHTML+=o}),$(".functionList li.draggable").draggableList({target:"ol.program",placeholder:'<li class="placeholder"/>',copy:!0,ondrag:function(){t.showHints()},onchange:function(){t.storeProgram(),t.sortLists()},onaddelem:function(n){t.checkForChanges(n)}})},runProgram:function(){this.following||this.colliding||(this.paused?this.mirobot.resume():(this.prog=new FnInstance(null,null,null),this.generate($(".editor ol.program")[0],this.prog),this.prog.run()),this.pause.show(),this.runner.hide(),this.paused=!1)},pauseProgram:function(){var t=this;this.paused=!0,this.mirobot.pause(function(){t.runner.show(),t.pause.hide()})},stopProgram:function(t){var n=this;this.mirobot.stop(function(){n.runner.show(),n.pause.hide(),n.paused=!1,n.colliding=!1,n.following=!1,n.updateState(),t&&t()})},clearProgram:function(){this.stopProgram(),$(".editor ol.program li.function").remove(),this.storeProgram(),this.showHints()},updateState:function(){this.follow[0].innerHTML=this.following?"&#9724; Stop Following Lines":"&#9654; Start Following Lines",this.collide[0].innerHTML=this.colliding?"&#9724; Stop Collision Detection":"&#9654; Start Collision Detection",this.runner[0].className=this.colliding||this.following?"run disabled":"run"},followClick:function(){var t=this;t.following?t.stopProgram():t.stopProgram(function(){t.mirobot.follow(function(){t.following=!0,t.updateState()})})},collideClick:function(){var t=this;this.colliding?this.stopProgram():this.stopProgram(function(){t.mirobot.collide(function(){t.colliding=!0,t.updateState()})})},generate:function(t,n){var e=this;snack.each(t.childNodes,function(t){if("li"===t.nodeName.toLowerCase()&&t.className.match(/function/)&&t.dataset.fntype){var o=e.fns[t.dataset.fntype],i=new FnInstance(o,t,e.mirobot);if(n.addChild(i),"parent"===o.type)for(var r=t.childNodes,a=0;a<r.length;a++)"ol"===r[a].nodeName.toLowerCase()&&e.generate(r[a],i)}})},functions:[{name:"move",type:"child",content:["Move",{input:"option",name:"direction","default":"forward",values:["forward","back"]},"by",{input:"number",name:"distance","default":100},"mm"],run:function(t,n,e){n.move(t.args().direction,t.args().distance,e)}},{name:"turn",type:"child",content:["Turn",{input:"option",name:"direction","default":"left",values:["left","right"]},"by",{input:"number",name:"angle","default":90},"degrees"],run:function(t,n,e){n.turn(t.args().direction,t.args().angle,e)}},{name:"penup",type:"child",content:["Pen up"],run:function(t,n,e){n.penup(e)}},{name:"pendown",type:"child",content:["Pen down"],run:function(t,n,e){n.pendown(e)}},{name:"repeat",type:"parent",content:["Repeat",{input:"number",name:"count","default":2},"times"],run:function(t){for(var n=0;n<t.args().count;n++)for(var e=0;e<t.children.length;e++)t.children[e].run()}},{name:"beep",type:"child",content:["Beep for",{input:"number",name:"duration","default":.5},"seconds"],run:function(t,n){n.beep(1e3*t.args().duration)}}]},Builder.prototype.mainUI='<div class="left container"><h2>Toolbox</h2><ol class="functionList"></ol><div class="extra"><button id="follow">&#9654; Start Following Lines</button><button id="collide">&#9654; Start Collision Detection</button></div></div><div class="right container"><h2>Program</h2><div class="programWrapper"><ol class="program" id="program"><li class="end"><div class="hint">Drag functions from the left over here!</div></li></div></ol><div class="buttons"><button class="run">&#9654; Run</button><button class="pause" style="display:none;">&#10074;&#10074; Pause</button><button class="stop">&#9724; Stop</button><button class="clear">&#10006; Clear</button></div></div>';