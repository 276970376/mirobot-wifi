var Mirobot=function(t){this.url=t,this.connect(),this.cbs={},this.listeners=[]};Mirobot.prototype={connected:!1,connect:function(){if(!this.connected){var t=this;this.ws=new WebSocket(this.url),this.ws.onmessage=function(s){t.handle_ws(s)},this.ws.onopen=function(){t.setConnectedState(!0)},this.ws.onerror=function(s){t.handleError(s)},this.ws.onclose=function(s){t.handleError(s)}}},setConnectedState:function(t){var s=this;s.connected=t,setTimeout(function(){s.broadcast(s.connected?"connected":"disconnected")},500),t?s.reconnectTimer&&(clearInterval(s.reconnectTimer),s.reconnectTimer=void 0):s.reconnectTimer||(s.connect(),s.reconnectTimer=setInterval(function(){s.connect()},1e3))},broadcast:function(t){for(i in this.listeners)this.listeners[i](t)},addListener:function(t){this.listeners.push(t)},handleError:function(t){t instanceof CloseEvent?this.setConnectedState(!1):console.log(t)},move:function(t,s,n){this.send({cmd:t,arg:s},n)},turn:function(t,s,n){this.send({cmd:t,arg:s},n)},penup:function(t){this.send({cmd:"penup"},t)},pendown:function(t){this.send({cmd:"pendown"},t)},beep:function(t,s){this.send({cmd:"beep",arg:t},s)},collide:function(t){this.send({cmd:"collide"},t)},follow:function(t){this.send({cmd:"follow"},t)},stop:function(t){var s=this;this.send({cmd:"stop"},function(n,e,i){if("complete"===n&&!i){for(var c in s.cbs)s.cbs[c]("complete",void 0,!0);s.robot_state="idle",s.msg_stack=[],s.cbs={},t&&t(n)}})},pause:function(t){this.send({cmd:"pause"},t)},resume:function(t){this.send({cmd:"resume"},t)},ping:function(t){this.send({cmd:"ping"},t)},version:function(t){this.send({cmd:"version"},t)},send:function(t,s){t.id=Math.random().toString(36).substr(2,10),s&&(this.cbs[t.id]=s),t.arg&&(t.arg=t.arg.toString()),["stop","pause","resume","ping","version"].indexOf(t.cmd)>=0?(console.log(t),this.ws.send(JSON.stringify(t))):this.push_msg(t)},push_msg:function(t){this.msg_stack.push(t),this.run_stack()},run_stack:function(){"idle"===this.robot_state&&this.msg_stack.length>0&&(this.robot_state="receiving",console.log(this.msg_stack[0]),this.ws.send(JSON.stringify(this.msg_stack[0])))},handle_ws:function(t){msg=JSON.parse(t.data),console.log(msg),this.msg_stack.length>0&&this.msg_stack[0].id==msg.id?"accepted"===msg.status?(this.cbs[msg.id]&&this.cbs[msg.id]("started",msg),this.robot_state="running"):"complete"===msg.status&&(this.cbs[msg.id]&&(this.cbs[msg.id]("complete",msg),delete this.cbs[msg.id]),this.msg_stack.shift(),0===this.msg_stack.length&&this.broadcast("program_complete"),this.robot_state="idle",this.run_stack()):this.cbs[msg.id]&&(this.cbs[msg.id]("complete",msg),delete this.cbs[msg.id])},robot_state:"idle",msg_stack:[]};