<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>WiFi connection</title>
<style>body{background-color:#FFF;font-family:sans-serif}label{display:block;margin:10px 0}.info{margin:15px 0;font-size:85%%;color:#999}.info p{margin:6px 0}h1{font-size:1.25em}h1 input{margin:0 10px 0 0}#message{margin:10px 0}</style>
<script type="text/javascript">function scanAPs(){var e=xhrObject();e.open("GET","wifiscan.cgi"),e.onreadystatechange=function(){if(4==e.readyState&&e.status>=200&&e.status<300){var n=JSON.parse(e.responseText);if("0"===n.result.inProgress&&n.result.APs.length>1){aps=[];for(var t=0;t<n.result.APs.length;t++)(""!=n.result.APs[t].essid||0!=n.result.APs[t].rssi)&&aps.push(n.result.APs[t]);aps.sort(function(e,n){return e.rssi<n.rssi?1:n.rssi<e.rssi?-1:0}),setAPSelect(aps),window.setTimeout(scanAPs,2e4)}else window.setTimeout(scanAPs,1e3)}},e.send()}var settings={clientSSID:"%clientSSID%",wifiMode:"%wifiMode%",clientIp:"%clientIp%",clientGateway:"%clientGateway%",clientNetmask:"%clientNetmask%",clientDhcp:"%clientDhcp%",clientMac:"%clientMac%",clientConnected:"%clientConnected%",APAuth:"%APAuth%",APChannel:"%APChannel%",APSSID:"%APSSID%"};settings.clientSSID.indexOf("clientSSID")>-1&&(settings={clientSSID:"foo",wifiMode:"3",clientIp:"192.168.1.100",clientGateway:"192.168.1.1",clientNetmask:"255.255.255.0",clientDhcp:"true",clientMac:"10:20:30:40:50:60",clientConnected:"true",APAuth:"0",APChannel:"6",APSSID:"Mirobot-abcd"});var xhrObject=function(e){for(e=0;4>e;e++)try{return e?new ActiveXObject(["Msxml2","Msxml3","Microsoft"][e]+".XMLHTTP"):new XMLHttpRequest}catch(n){}},aps=[],el=function(e){return document.getElementById(e)},getAP=function(e){for(var n=0;n<aps.length;n++)if(aps[n].essid===e)return aps[n];return null},showHide=function(){el("clientDetails").style.display=document.getElementById("wifiClientEnabled").checked?"block":"none",el("APDetails").style.display=document.getElementById("wifiAPEnabled").checked?"block":"none",el("APAuthPass").style.display="0"===document.getElementById("APAuth").value?"none":"block";var e=getAP(el("clientSSID").value);el("clientPasswdInput").style.display=!e||e.enc>0?"block":"none",el("APChannelInput").style.display=document.getElementById("wifiClientEnabled").checked?"none":"block"};setAPSelect=function(e){for(var n,t=!1,i=0;i<e.length;i++)n+="<option value="+e[i].essid,e[i].essid===settings.clientSSID&&(t=!0,n+=' selected="selected"'),n+=">"+e[i].essid+"</option>";t||(n="<option value="+settings.clientSSID+' selected="selected">'+settings.clientSSID+" (not currently visible)</option>"+n),n="<option>Select the WiFi Access Point</option>"+n,el("clientSSID").innerHTML=n,showHide()};var setupForm=function(){el("wifiClientEnabled").checked=!!(1&settings.wifiMode),el("wifiClientEnabled").onchange=showHide,el("clientPasswdInput").style.display="none",el("clientSSID").onchange=showHide,el("wifiAPEnabled").checked=!!(2&settings.wifiMode),el("wifiAPEnabled").onchange=showHide,el("clientMac").innerHTML=settings.clientMac,el("clientIpVal").innerHTML=settings.clientIp,el("APSSID").value=settings.APSSID,el("submit").onclick=sendForm;for(var e,n=1;11>n;n++)e+='<option value="'+n+'"',n===parseInt(settings.APChannel)&&(e+=' selected="selected"'),e+=">"+n+"</option>";el("APChannel").innerHTML=e;var t=["None","WEP","WPA PSK","WPA2 PSK","WPA / WPA2 PSK"];e="";for(var n=0;n<t.length;n++)e+='<option value="'+n+'"',n===parseInt(settings.APAuth)&&(e+=' selected="selected"'),e+=">"+t[n]+"</option>";el("APAuth").innerHTML=e,el("APAuth").onchange=showHide,showHide()},getWifiMode=function(){return el("wifiAPEnabled").checked&&el("wifiClientEnabled").checked?3:el("wifiAPEnabled").checked?2:el("wifiClientEnabled").checked?1:0},makeVars=function(){var e={};if(getWifiMode()!==parseInt(settings.wifiMode)&&(e.wifiMode=getWifiMode()),getWifiMode()&!0){e.clientSSID=el("clientSSID").value;var n=getAP(e.clientSSID);if(n&&n.enc>0&&""===el("clientPasswd").value)return msg("Please enter a password to join the "+n.essid+" network"),null;""!==el("clientPasswd").value&&(e.clientPasswd=el("clientPasswd").value)}getWifiMode()&!0&&(e.APSSID=el("APSSID").value,e.wifiMode&!1&&(e.APChannel=el("APChannel").value));for(var t in e)e[t]===settings[t]&&delete e[t];return console.log(e),e},sendForm=function(){var e=xhrObject(),n="",t=[],i=makeVars();if(i){for(var s in i)t.push(encodeURIComponent(s)+"="+encodeURIComponent(i[s]));0!==t.length&&(n=t.join("&").replace(/%%20/g,"+"),e.onreadystatechange=function(){4==e.readyState&&msg(e.status>=200&&e.status<300?"Configuration saved":"Error saving configuration")},e.open("POST","settings.cgi"),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.send(n))}},msg=function(e){el("message").innerHTML=e};window.onload=function(){setupForm(),scanAPs()};</script>
</head>
<body>
<h1>
<input type="checkbox" id="wifiClientEnabled">WiFi Client</h1>
<div id="clientDetails">
<select id="clientSSID"><option>Looking for Access Points...</option></select><label id="clientPasswdInput">Password: <input type="password" id="clientPasswd"></label><!--
    <label><input type="checkbox" id="clientDHCP">Use DHCP</label>
    <div id="clientDHCPSettings">
      <label>IP Address: <input type="text" id="clientIp"></label>
      <label>Netmask: <input type="text" id="clientNetmask"></label>
      <label>Gateway: <input type="text" id="clientGateway"></label>
    </div>
    --><div class="info">
<p>IP Address: <span id="clientIpVal"></span></p>
<p>MAC Address: <span id="clientMac"></span></p>
</div>
</div>
<h1>
<input type="checkbox" id="wifiAPEnabled">WiFi Access Point</h1>
<div id="APDetails">
<label>Access Point Name: <input type="text" id="APSSID"></label><label id="APChannelInput">Channel: <select id="APChannel"></select></label><label>Encryption: <select id="APAuth"></select></label><label id="APAuthPass">Password: <input type="password" id="APAuthPassword"></label>
</div>
<button id="submit">Save Settings</button><div id="message"></div>
</body>
</html>
