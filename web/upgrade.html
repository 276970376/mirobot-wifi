<!DOCTYPE html>
<html><head><title>WiFi connection</title>
<style>
body {
	background-color: #FFF;
	font-family: sans-serif;
}
label{
  display:block;
  margin:10px 0;
}
.info{
  margin:15px 0;
  font-size:85%%;
  color:#999;
}
.info p{margin:6px 0}
h1{font-size:1.25em}
#message{
  margin:10px 0;
}
#fileInput{
  border:3px dashed #AAA;
  width:100%;
  height:500px;
}
</style>
<script type="text/javascript">

var fileContents;
var binFileContents;

var hex2bin = function(hex){
  var chars = []
  hex.toString().split('\n').map(function(line){
    var linelength = parseInt(line.slice(1, 3), 16);
    if(linelength && line.slice(7, 9) === '00') {
      data = line.slice(9, 9 + 2 * linelength);
      for(var j = 0; j< 2*linelength; j+=2){
        chars.push(parseInt(data.slice(j, j+2), 16));
      }
    }
  });
  // Make the length a multiple of 4 for writing to flash
  for(var i=0; i<chars.length % 4; i++){
    chars.push(0);
  }
  return new Uint8Array(chars);
}

function readFile(f){
  var r = new FileReader(f);
  r.onload = function(e) {
    fileContents = e.target.result;
    binFileContents = hex2bin(fileContents);
    console.log(fileContents.substr(1, fileContents.indexOf("\n")));
    document.getElementById('fileInput').style.display = 'none';
    document.getElementById('upload').style.display = 'block';
  }
  r.readAsText(f);
}

function handleFileSelect(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  if(typeof evt.dataTransfer !== 'undefined'){
    var files = evt.dataTransfer.files;
  }else if(typeof evt.target !== 'undefined'){
    var files = evt.target.files;
  }
  if(files.length != 1){
    alert("please select a single hex file to upload");
    return;
  }
  readFile(files[0]);
  return false;
}

function handleDragOver(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
}

var doUpload = function(){
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/updatearduino.cgi');
  xhr.onload = function(e) {
    if (this.status >= 200 && this.status < 300) {
      document.getElementById('upload').style.display = 'none';
      document.getElementById('flash').style.display = 'block';
    }else{
      console.log("Error");
    }
  };
  xhr.send(binFileContents);
}

var updateStatus = function(){
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/flasharduino.cgi');
  xhr.onload = function(e) {
    if (this.status >= 200 && this.status < 300) {
      var status = JSON.parse(xhr.response);
      if(status.state === 'flashing'){
        document.getElementById('msg').innerHTML = "Arduino flashing (" + Math.floor((status.pages / 240) * 100) + "%)";
        window.setTimeout(updateStatus, 1000);
      }else{
        document.getElementById('msg').innerHTML = "Arduino flashing complete";
      }
    }else{
      console.log("Error");
    }
  };
  xhr.send();
}

var doFlash = function(){
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/flasharduino.cgi');
  xhr.onload = function(e) {
    if (this.status >= 200 && this.status < 300) {
      document.getElementById('flash').style.display = 'none';
      document.getElementById('msg').innerHTML = "Arduino flashing (0%)"
      document.getElementById('msg').style.display = 'block';
    }else{
      console.log("Error");
    }
  };
  xhr.send();
  window.setTimeout(updateStatus, 1000);
}

var pullFile = function(url){
  console.log("Fetching: " + url);
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function(){
    if(xhr.readyState === 4 && xhr.status === 200){
      //get ready to send it to the ESP
    }
  }
  xhr.open('GET', 'http://corsify.appspot.com/' + url, true);
  xhr.send();
}

var pullVersions = function(){
  var xhr = new XMLHttpRequest();

  xhr.onreadystatechange = function(){
    if(xhr.readyState === 4 && xhr.status === 200){
      var res = JSON.parse(xhr.response);
      for(var i = 0; i< res.length; i++){
        if(!res[i].prerelease){
          console.log(res[i]);
          if(res[i].assets.length > 0){
            for(var j=0; j<res[i].assets.length; j++){
              if(res[i].assets[j].name === 'mirobot.hex'){
                pullFile(res[i].assets[j].browser_download_url);
                return;
              }
            }
          }
        }
      }
    }
  }
  
  xhr.open('GET', 'https://api.github.com/repos/bjpirt/mirobot-arduino/releases', true);
  xhr.send();
}

var init = function(){
  document.getElementById('fileInput').onclick = function(){
    document.getElementById('files').click();
  }
  document.getElementById('files').addEventListener('change', handleFileSelect, false);
  // Setup the dnd listeners.
  var dropZone = document.getElementById('fileInput');
  dropZone.addEventListener('dragover', handleDragOver, false);
  dropZone.addEventListener('drop', handleFileSelect, false);
  document.querySelector('#upload button').onclick = doUpload;
  document.querySelector('#flash button').onclick = doFlash;
  //pullVersions();
}

window.onload=function(e) {
  init();
};
</script>
</head>
<body>
  <h1>Upgrade Arduino</h1>
  <div id="fileInput">
    <p>Drag and drop the hex file here or click to choose the file manually</p>
    <input type="file" id="files" style="display:none">
  </div>
  <div id="upload" style="display:none">
    <button>Upload new firmware</button>
  </div>
  <div id="flash" style="display:none">
    <button>Flash new firmware</button>
  </div>
  <p id="msg" style="display:none"></p>
</body>
</html>
