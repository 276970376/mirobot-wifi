<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Mirobot Control</title>
  <meta name="viewport" content="width=900, user-scalable=no">
  <style>
body{
  font-family:sans-serif, arial;
  font-size:80%;
}
thead{
  font-weight:bold;
  background-color:#CCC;
}
tbody tr.info:nth-child(even){
  background-color:#ddd;
}
tbody tr.info:nth-child(odd){
  background-color:#eee;
}
tbody tr.error{
  background-color:#FAA;
}
tbody tr.success{
  background-color:#AFA;
}
td{
  padding:3px 10px 3px 3px;
}
  </style>
</head>
<body>
  <table>
    <thead>
      <td>Time</td><td>Event</td>
    </thead>
    <tbody>
    
    </tbody>
  </table>
  <script type="text/javascript">
var hashConfig = {};
var ws;
var lastId;
var pingTimeout;

if(window.location.hash !== ''){
  window.location.hash.replace('#', '').split('&').map(function(el){
    var split = el.split('=');
    hashConfig[split[0]] = split[1];
  });
}

var log = function(msg, level){
  console.log(msg);
  level = level || 'info';
  var tr = document.createElement('tr');
  tr.className = level;
  var date_td = document.createElement('td');
  tr.appendChild(date_td);
  var msg_td  = document.createElement('td');
  tr.appendChild(msg_td);
  date_td.innerHTML = new Date();
  msg_td.innerHTML = msg;
  document.querySelector('table tbody').appendChild(tr);
}

var ping = function(){
  if(ws.readyState == 1){
    lastId = Math.random().toString(36).substr(2, 10)
    ws.send(JSON.stringify({cmd: 'version', id: lastId}));
    pingTimeout = window.setTimeout(function(){
      lastId = undefined;
      log("Ping timeout", "error");
      console.log(ws);
      window.setTimeout(ping, 3000);
    }, 2000);
  }else{
    log("ws.readyState = " + ws.readyState);
    window.setTimeout(ping, 3000);
  }
}

var pingResponse = function(msg){
  if(lastId){
    window.clearTimeout(pingTimeout);
    msg = JSON.parse(msg.data);
    if(msg.id === lastId){
      log("Successful ping", 'success');
    }else{
      log("Error pinging", 'error');
    }
    window.setTimeout(ping, 3000);
  }
}

var connect = function(){
  var host = hashConfig['m'] || window.location.hostname;
  var address = 'ws://' + host + ':8899/websocket';
  log("Connecting to " + address);
  ws = new WebSocket(address);
  ws.onopen = function(){
    log("WebSocket open", 'success');
    ping();
  }
  ws.onerror = function(e){
    log("WebSocket error", 'error');
    console.log(e);
  }
  ws.onclose = function(){
    log("WebSocket closed", 'error');
    window.setTimeout(connect, 5000);
  }
  ws.onmessage = pingResponse;
}

connect();

  </script>
</body>
</html>
